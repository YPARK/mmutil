---
title: "Demonstration of single cell data processing on the pancreas data"
author: "Yongjin Park"
date: "`r Sys.time()`"
---

```{r include=FALSE}
library("R.utils")
library("lemon")
source("Util-rmd.R")

fig.dir = 'Fig/example/pancreas_2018-08-13/'
dir.create(fig.dir, recursive = TRUE, showWarnings = FALSE)
knitr::opts_chunk$set(fig.path = fig.dir, fig.width = 6, fig.height = 4)
options(stringsAsFactors = FALSE)
```

We assume the following executable files are properly installed:

* `mmutil_merge_col`

* `mmutil_filter_row`

* `mmutil_spectral_cluster_col`

## Preprocessing

Create a working directory:

```{bash}
[ -d example/pancreas_2018-08-13/ ] || mkdir -p example/pancreas_2018-08-13/
```

### Merge multiple data files

We merge multiple files for convenience while discarding cells with fewer than 100 genes.

```{bash}
export BATCHES=$(ls -1 data/pancreas_2018-08-13/*.mtx.gz | xargs -I file basename file .mtx.gz)

if ! [ -f example/pancreas_2018-08-13/genes.tsv.gz ] ; then
	zcat data/pancreas_2018-08-13/*_genes.tsv.gz | \
	awk '{ genes[$2]=1 } END { for(g in genes) print g }' | \
	sort | \
	gzip > example/pancreas_2018-08-13/genes.tsv.gz
fi

for b in $BATCHES; do
	[ -f example/pancreas_2018-08-13/${b}_genes.tsv.gz ] || gzip -cd data/pancreas_2018-08-13/${b}_genes.tsv.gz | awk '{ print $2 }' | gzip > example/pancreas_2018-08-13/${b}_genes.tsv.gz

	[ -f example/pancreas_2018-08-13/${b}_barcodes.tsv.gz ] || gzip -cd data/pancreas_2018-08-13/${b}_barcodes.tsv.gz | awk -v batch=${b} -F'-' '{ print $1 FS batch }' | gzip > example/pancreas_2018-08-13/${b}_barcodes.tsv.gz
done

if ! [ -f example/pancreas_2018-08-13/merged.mtx.gz ]; then

	mmutil_merge_col \
		example/pancreas_2018-08-13/genes.tsv.gz 500 \
		example/pancreas_2018-08-13/merged \
		$(echo $BATCHES | sed 's/ /\n/g' | awk '{ print "data/pancreas_2018-08-13/" $1 ".mtx.gz" FS  "example/pancreas_2018-08-13/" $1 "_genes.tsv.gz" FS "example/pancreas_2018-08-13/" $1 "_barcodes.tsv.gz" }')

fi
```

### Select top `10000` most variable features

```{bash}
if ! [ -f example/pancreas_2018-08-13/top.mtx.gz ]; then
    mmutil_filter_row 10000 \
    example/pancreas_2018-08-13/merged.mtx.gz \
    example/pancreas_2018-08-13/merged.rows.gz \
    example/pancreas_2018-08-13/top \
    2> /dev/null
fi

# just copy the barcode file to be consistent
if ! [ -f example/pancreas_2018-08-13/top.barcodes.tsv.gz ]; then
	zcat example/pancreas_2018-08-13/merged.columns.gz | \
	awk '{ print $1 }' | \
	gzip > example/pancreas_2018-08-13/top.barcodes.tsv.gz
fi
```

Show the full spectrum of the feature scores:

```{r fig_var_score}
out.dir = "example/pancreas_2018-08-13/"

var.scores = out.dir %&% "top.full_scores.gz" %>%
    read_tsv(col_names="var", col_types="d") %>%
    mutate(idx = 1:n())

.gg.plot(var.scores, aes(x=idx, y=log(1 + var))) +
    geom_vline(xintercept=10000, lty=2, col='red') +
    geom_line(size=2) +
    ylab("log(1 + variance)") +
    xlab("ranked features")
```

## Run clustering combining all together

Let's visualize clustering results with the following function:

```{r}
.show.scatter = function(.argmax, .embed) {

    argmax.tab = fread(.argmax) %>%
        (function(x) { colnames(x) = c("TAG", "k"); x })

    embedded.tab = fread(.embed) %>%
        (function(x) { colnames(x) = c("e1", "e2"); x })

    ## Show 2D embedding of those clusters of cells

    .K = max(argmax.tab$k)
    .lab = c("cluster" %&% 1:.K, "unassigned")

    argmax.tab = argmax.tab[, k := factor(k, c(1:.K, -1), .lab)]

    .dt = cbind(argmax.tab, embedded.tab) %>%
        na.omit() %>%
        filter(k != "unassigned")

    p1 =
        .gg.plot(.dt, aes(x=e1, y=e2, color=as.factor(k))) +
        theme(legend.title=element_blank()) +
        theme(legend.position=c(1,1), legend.justification=c(1,1)) +
        geom_point(size=.5)

    print(p1)

    ## show some labels
    .df = as_tibble(.dt) %>%
        separate("TAG", c("barcode", "state"), sep="[-]") %>% 
        filter(k != "unassigned")

    p2 =
        .gg.plot(.df, aes(x=e1, y=e2, color=state)) +
        theme(legend.title=element_blank()) +
        theme(legend.position=c(0,1), legend.justification=c(0,1)) +
        geom_point(size=.5)

    print(p2)
}
```

### Gaussian Mixture Model after spectral transformation

```{bash}
if ! [ -f example/pancreas_2018-08-13/gmm.argmax.gz ]; then
    mmutil_spectral_cluster_col --mtx example/pancreas_2018-08-13/top.mtx.gz \
                                --method GMM --trunc 10 --verbose --rank 5 \
                                --kmeanspp --burnin 100 --log_scale \
                                --embedding_epochs 30 \
                                --col example/pancreas_2018-08-13/top.barcodes.tsv.gz \
                                --out example/pancreas_2018-08-13/gmm 2> /dev/null
fi
```

Read and show GMM estimation results:

```{r fig_scatter_gmm}
.show.scatter(out.dir %&% "/gmm.argmax.gz",
              out.dir %&% "/gmm.embedded.gz")
```

### Density-based spectral clustering

A strong distributional assumption of underlying data often result in
poor clustering results while density-based non-parametric clustering
methods robustly identify clusters of data points distributed in an
arbitrary fashion.

```{bash}
if ! [ -f example/pancreas_2018-08-13/dbscan_level_1.argmax.gz ]; then
    mmutil_spectral_cluster_col --mtx example/pancreas_2018-08-13/top.mtx.gz \
	                            --rank 5 --epsilon 0.05 --embedding_epochs 30 \
                                --method DBSCAN --knn 100 --prune_knn \
								--min_size 100 --log_scale --verbose \
                                --col example/pancreas_2018-08-13/top.barcodes.tsv.gz \
                                --out example/pancreas_2018-08-13/dbscan 2> /dev/null
fi
```

Read and show DBSCAN estimation at level 1:

```{r fig_scatter_dbscan_1}
.show.scatter(out.dir %&% "/dbscan_level_1.argmax.gz",
              out.dir %&% "/dbscan_level_1.embedded.gz")
```

Read and show DBSCAN estimation at level 2:

```{r fig_scatter_dbscan_2}
.show.scatter(out.dir %&% "/dbscan_level_2.argmax.gz",
              out.dir %&% "/dbscan_level_2.embedded.gz")
```

Read and show DBSCAN estimation at level 3:

```{r fig_scatter_dbscan_3}
.show.scatter(out.dir %&% "/dbscan_level_3.argmax.gz",
              out.dir %&% "/dbscan_level_3.embedded.gz")
```

## Show the results on E14.5

```{bash}
export BATCHES=$(ls -1 data/pancreas_2018-08-13/*E14*.mtx.gz | xargs -I file basename file .mtx.gz)

for b in $BATCHES; do
	[ -f example/pancreas_2018-08-13/${b}_genes.tsv.gz ] || gzip -cd data/pancreas_2018-08-13/${b}_genes.tsv.gz | awk '{ print $2 }' | gzip > example/pancreas_2018-08-13/${b}_genes.tsv.gz

	[ -f example/pancreas_2018-08-13/${b}_barcodes.tsv.gz ] || gzip -cd data/pancreas_2018-08-13/${b}_barcodes.tsv.gz | awk -v batch=${b} -F'-' '{ print $1 FS batch }' | gzip > example/pancreas_2018-08-13/${b}_barcodes.tsv.gz
done

if ! [ -f example/pancreas_2018-08-13/merged_e14.mtx.gz ]; then

	mmutil_merge_col \
		example/pancreas_2018-08-13/genes.tsv.gz 500 \
		example/pancreas_2018-08-13/merged_e14 \
		$(echo $BATCHES | sed 's/ /\n/g' | awk '{ print "data/pancreas_2018-08-13/" $1 ".mtx.gz" FS  "example/pancreas_2018-08-13/" $1 "_genes.tsv.gz" FS "example/pancreas_2018-08-13/" $1 "_barcodes.tsv.gz" }')

fi

# just copy the barcode file to be consistent
if ! [ -f example/pancreas_2018-08-13/merged_e14.barcodes.tsv.gz ]; then
	zcat example/pancreas_2018-08-13/merged_e14.columns.gz | \
	awk '{ print $1 }' | \
	gzip > example/pancreas_2018-08-13/merged_e14.barcodes.tsv.gz
fi
```

### Gaussian Mixture Model after spectral transformation

```{bash}
if ! [ -f example/pancreas_2018-08-13/gmm_e14.argmax.gz ]; then
    mmutil_spectral_cluster_col --mtx example/pancreas_2018-08-13/merged_e14.mtx.gz \
                                --method GMM --trunc 10 --verbose --rank 5 \
                                --kmeanspp --burnin 100 --log_scale \
                                --embedding_epochs 30 \
                                --col example/pancreas_2018-08-13/merged_e14.barcodes.tsv.gz \
                                --out example/pancreas_2018-08-13/gmm_e14 2> /dev/null
fi
```

Read and show GMM_E14 estimation results:

```{r fig_scatter_gmm_e14}
.show.scatter(out.dir %&% "/gmm_e14.argmax.gz",
              out.dir %&% "/gmm_e14.embedded.gz")
```

### Density-based spectral clustering

A strong distributional assumption of underlying data often result in
poor clustering results while density-based non-parametric clustering
methods robustly identify clusters of data points distributed in an
arbitrary fashion.

```{bash}
if ! [ -f example/pancreas_2018-08-13/dbscan_e14_level_1.argmax.gz ]; then
    mmutil_spectral_cluster_col --mtx example/pancreas_2018-08-13/merged_e14.mtx.gz \
	                            --rank 5 --epsilon 0.05 --embedding_epochs 30 \
                                --method DBSCAN --knn 100 --prune_knn \
								--min_size 10 --log_scale --verbose \
                                --col example/pancreas_2018-08-13/merged_e14.barcodes.tsv.gz \
                                --out example/pancreas_2018-08-13/dbscan_e14 2> /dev/null
fi
```

Read and show DBSCAN estimation at level 1:

```{r fig_scatter_dbscan_e14_1}
.show.scatter(out.dir %&% "/dbscan_e14_level_1.argmax.gz",
              out.dir %&% "/dbscan_e14_level_1.embedded.gz")
```

Read and show DBSCAN estimation at level 2:

```{r fig_scatter_dbscan_e14_2}
.show.scatter(out.dir %&% "/dbscan_e14_level_2.argmax.gz",
              out.dir %&% "/dbscan_e14_level_2.embedded.gz")
```

Read and show DBSCAN estimation at level 3:

```{r fig_scatter_dbscan_e14_3}
.show.scatter(out.dir %&% "/dbscan_e14_level_3.argmax.gz",
              out.dir %&% "/dbscan_e14_level_3.embedded.gz")
```

Read and show DBSCAN estimation at level 8:

```{r fig_scatter_dbscan_e14_8}
.show.scatter(out.dir %&% "/dbscan_e14_level_8.argmax.gz",
              out.dir %&% "/dbscan_e14_level_8.embedded.gz")
```
