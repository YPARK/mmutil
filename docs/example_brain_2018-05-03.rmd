---
title: "Demonstration of single cell data processing on the brain data"
author: "Yongjin Park"
date: "`r Sys.time()`"
---

```{r include=FALSE}
library("R.utils")
library("lemon")
source("Util-rmd.R")

fig.dir = 'Fig/example/brain_2018-05-03/'
dir.create(fig.dir, recursive = TRUE, showWarnings = FALSE)
knitr::opts_chunk$set(fig.path = fig.dir, fig.width = 4, fig.height = 3)
options(stringsAsFactors = FALSE)
```

We assume the following executable files are properly installed:

* `mmutil_filter_row`

* `mmutil_spectral_cluster_col`

```{r}
Sys.time()
```

## Preprocessing

Create a working directory:

```{bash}
[ -d example/brain_2018-05-03/ ] || mkdir -p example/brain_2018-05-03/
```

## Run clustering

Meta data to compare with the previous annotations:

```{r}
meta.file = "data/brain_2018-05-03/filtered_column_metadata.txt"
meta.tab = fread(meta.file)
```

Let's visualize clustering results with the following function:

```{r}
brain.color = read_tsv("brain_colors.txt")

.show.scatter = function(.argmax, .embed) {

    argmax.tab = fread(.argmax) %>%
        (function(x) { colnames(x) = c("col", "k"); x })

    argmax.tab = argmax.tab[, TAG := meta.tab$TAG]

    embedded.tab = fread(.embed) %>%
        (function(x) { colnames(x) = c("e1", "e2"); x })

    ## Show 2D embedding of those clusters of cells

    .K = max(argmax.tab$k)
    .lab = c("cluster" %&% 1:.K, "unassigned")

    argmax.tab = argmax.tab[, k := factor(k, c(1:.K, -1), .lab)]

    .dt = cbind(argmax.tab, embedded.tab) %>% na.omit()

    p1 =
        .gg.plot(.dt, aes(x=e1, y=e2, color=as.factor(k))) +
        theme(legend.position = "none") +
        geom_point(size=.5)

    print(p1)

    ## Remove outlier cells
    .dt2 = merge(.dt, meta.tab, by = "TAG")[k != "unassigned"]

    .color = .dt2[, .(broad.cell.type)] %>%
        unique() %>%
        left_join(brain.color, by = "broad.cell.type")

    .dt2[, celltype := factor(broad.cell.type, .color$broad.cell.type)]

    p2 =
        .gg.plot(.dt2, aes(x=e1, y=e2, color=celltype)) +
        theme(legend.position = c(0,1), legend.justification = c(0,1)) +
        geom_point(size=.5) +
        scale_color_manual(values = .color$hex)

    print(p2)
}
```

```{r}
out.dir = "example/brain_2018-05-03"
```

### Gaussian Mixture Model after spectral transformation
```{bash}
if ! [ -f example/brain_2018-05-03/temp.u.gz ] ; then
	mmutil_spectral_col --mtx data/brain_2018-05-03/filtered_count_matrix.mtx.gz \
       --rank 50 --log_scale --sampling_method CV --col_norm 10000 --out example/brain_2018-05-03/temp 
fi
```

```{bash}
if ! [ -f example/brain_2018-05-03/gmm.argmax.gz ]; then
	
	zcat example/brain_2018-05-03/temp.u.gz | cut -f 2-30 -d ' ' | gzip > example/brain_2018-05-03/temp.30.u.gz

    mmutil_spectral_cluster_col --sdata example/brain_2018-05-03/temp.30.u.gz \
                                --method GMM --trunc 50 --verbose \
                                --kmeanspp --burnin 500 --embedding_epochs 50 \
                                --out example/brain_2018-05-03/gmm 2>/dev/null
fi
```

Read and show GMM estimation results:

```{r fig_scatter_gmm}
.show.scatter(out.dir %&% "/gmm.argmax.gz",
              out.dir %&% "/gmm.embedded.gz")
```
